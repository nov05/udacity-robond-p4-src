<?xml version="1.0" encoding="UTF-8"?>

<launch>

    <!-- Launch "my_robot" in the udacity office -->
    <!-- $ roslaunch main udacity_office.launch -->
    <include file="$(find my_robot)/launch/udacity_office.launch"></include>

    <node pkg="nodelet" type="nodelet" name="points_xyzrgb"
        args="standalone rtabmap_util/point_cloud_xyzrgb">
        <remap from="rgb/image" to="$(arg rgb_topic)" />
        <remap from="depth/image" to="$(arg depth_topic)" />
        <remap from="rgb/camera_info" to="$(arg camera_info_topic)" />
        <!-- <remap from="rgb/image" to="/data_throttled_image" />
        <remap from="depth/image" to="/data_throttled_image_depth" />
        <remap from="rgb/camera_info" to="/data_throttled_camera_info" /> -->
        <remap from="cloud" to="voxel_cloud" />

        <param name="rgb/image_transport" type="string" value="compressed" />
        <param name="depth/image_transport" type="string" value="compressedDepth" />

        <param name="queue_size" type="int" value="10" />
        <param name="voxel_size" type="double" value="0.01" />
    </node>

    <!-- ROBOT MAPPING VERSION: use this with ROS bag demo_mapping.bag -->
    <!-- WARNING : Database is automatically deleted on each startup -->
    <!--           See "delete_db_on_start" option below... -->
    <!-- Refer to
        https://github.com/introlab/rtabmap_ros/blob/master/rtabmap_demos/launch/demo_robot_mapping.launch -->

    <!-- Arguments for launch file with defaults provided -->
    <!-- located at ~/.ros/rtabmap.db -->
    <arg name="database_path" default="rtabmap.db" />
    <arg name="rgb_topic" default="/camera/rgb/image_raw" />
    <arg name="depth_topic" default="/camera/depth/image_raw" />
    <arg name="camera_info_topic" default="/camera/rgb/camera_info" />
    <!-- Choose visualization -->
    <arg name="rviz" default="true" />
    <arg name="rtabmap_viz" default="false" />

    <!-- Mapping Node -->
    <group ns="rtabmap">
        <!-- Check the new names of the packages at http://wiki.ros.org/rtabmap_ros -->
        <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen"
            args="--delete_db_on_start">

            <!-- Basic RTAB-Map Parameters -->
            <param name="database_path" type="string" value="$(arg database_path)" />
            <!-- <param name="frame_id" type="string" value="base_footprint" /> -->
            <param name="frame_id" type="string" value="base_link" />
            <param name="wait_for_transform" type="bool" value="true" />
            <param name="odom_frame_id" type="string" value="odom" />
            <param name="subscribe_depth" type="bool" value="true" />
            <param name="subscribe_scan" type="bool" value="true" />
            <param name="rtabmap_viz" type="bool" value="$(arg rtabmap_viz)" />
            <param name="rviz" type="bool" value="$(arg rviz)" />

            <!-- added by nov05 -->
            <!-- As /az3/base_controller/odom topic doesn't provide covariances, we use TF to get
                odom and we fix the covariance -->
            <param name="odom_tf_linear_variance" type="double" value="0.001" />
            <param name="odom_tf_angular_variance" type="double" value="0.001" />

            <!-- RTAB-Map Inputs -->
            <remap from="scan" to="/scan" />
            <remap from="rgb/image" to="$(arg rgb_topic)" />
            <remap from="depth/image" to="$(arg depth_topic)" />
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)" />
            <!-- <remap from="rgb/image" to="/data_throttled_image" />
            <remap from="depth/image" to="/data_throttled_image_depth" />
            <remap from="rgb/camera_info" to="/data_throttled_camera_info" /> -->
            <param name="rgb/image_transport" type="string" value="compressed" />
            <param name="depth/image_transport" type="string" value="compressedDepth" />

            <!-- RTAB-Map Output -->
            <remap from="grid_map" to="/map" />

            <!-- Rate (Hz) at which new nodes are added to map -->
            <param name="Rtabmap/DetectionRate" type="string" value="1" />

            <!-- 2D SLAM -->
            <param name="Reg/Force3DoF" type="string" value="true" />

            <!-- Loop Closure Detection -->
            <!-- 0=SURF 1=SIFT 2=ORB 3=FAST/FREAK 4=FAST/BRIEF 5=GFTT/FREAK 6=GFTT/BRIEF 7=BRISK
                 8=GFTT/ORB 9=KAZE -->
            <param name="Kp/DetectorStrategy" type="string" value="0" />

            <!-- Maximum visual words per image (bag-of-words) -->
            <param name="Kp/MaxFeatures" type="string" value="400" />

            <!-- Used to extract more or less SURF features -->
            <param name="SURF/HessianThreshold" type="string" value="100" />

            <!-- Loop Closure Constraint -->
            <!-- 0=Visual, 1=ICP (1 requires scan)-->
            <param name="Reg/Strategy" type="string" value="0" />

            <!-- Minimum visual inliers to accept loop closure -->
            <param name="Vis/MinInliers" type="string" value="15" />

            <!-- Set to false to avoid saving data when robot is not moving -->
            <param name="Mem/NotLinkedNodesKept" type="string" value="false" />
        </node>
    </group>

    <!-- RViz -->
    <!-- $ rosrun rviz rviz -d ~/catkin_ws3/src/main/rviz/rtabmap.rviz -->
    <node if="$(arg rviz)" name="rviz" pkg="rviz" type="rviz" respawn="false" output="screen"
        args="-d $(find main)/rviz/rtabmap.rviz">
    </node>

</launch>